<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Katalog Undangan Digital</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FIREBASE COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wa: {
                            bg: '#111b21',       /* Background Utama Gelap */
                            header: '#202c33',   /* Header/Card */
                            button: '#2a373f',   /* Button Background (Lighter) */
                            teal: '#00a884',     /* Hijau WA */
                            light: '#e9edef',    /* Teks Utama */
                            gray: '#8696a0',     /* Teks Secondary */
                            divider: '#222d36'   /* Garis Pembatas */
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #111b21; color: #e9edef; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        
        /* Transisi Halaman */
        .view-section { display: none; animation: fadeIn 0.2s ease-out; }
        .view-active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Animasi Gallery */
        #view-gallery { transition: transform 0.3s ease-in-out; }
        .gallery-open { transform: translateY(0); }
        .gallery-closed { transform: translateY(100%); }
    </style>
</head>

<body class="antialiased min-h-screen pb-20">

    <!-- =======================
         VIEW 1: HOME (TIER LIST)
    ======================== -->
    <div id="view-home" class="view-section">
        <!-- Header Home -->
        <div class="sticky top-0 z-40 bg-wa-header shadow-md border-b border-wa-divider">
            <div class="px-4 h-14 flex justify-between items-center max-w-md mx-auto">
                <h1 class="font-medium text-lg text-wa-light tracking-wide">Katalog Undangan</h1>
                <div class="flex gap-4">
                    <svg class="w-5 h-5 text-wa-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <svg class="w-5 h-5 text-wa-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                </div>
            </div>
            
            <!-- Filter Chips -->
            <div class="px-4 pb-3 flex gap-2 overflow-x-auto hide-scroll max-w-md mx-auto">
                <button class="bg-[#374248] text-wa-teal px-4 py-1.5 rounded-full text-xs font-medium border border-wa-divider">Semua</button>
                <button class="bg-transparent text-wa-gray px-4 py-1.5 rounded-full text-xs font-medium border border-wa-divider">Wedding</button>
                <button class="bg-transparent text-wa-gray px-4 py-1.5 rounded-full text-xs font-medium border border-wa-divider">Khitan</button>
            </div>
        </div>

        <!-- Loading Skeleton -->
        <div id="home-loading" class="max-w-md mx-auto p-4 space-y-6">
            <div class="h-6 w-32 bg-wa-header rounded animate-pulse"></div>
            <div class="grid grid-cols-3 gap-2">
                <div class="aspect-[4/5] bg-wa-header rounded animate-pulse"></div>
                <div class="aspect-[4/5] bg-wa-header rounded animate-pulse"></div>
                <div class="aspect-[4/5] bg-wa-header rounded animate-pulse"></div>
            </div>
        </div>

        <!-- Container List Tier -->
        <div id="tier-list-container" class="max-w-md mx-auto pb-10 space-y-2 mt-2">
            <!-- Inject via JS -->
        </div>
    </div>


    <!-- =======================
         VIEW 2: CATEGORY FULL
    ======================== -->
    <div id="view-category" class="view-section">
        <!-- Header Category -->
        <div class="sticky top-0 z-40 bg-wa-header shadow-md border-b border-wa-divider">
            <div class="px-2 h-14 flex items-center gap-2 max-w-md mx-auto">
                <button onclick="goBack()" class="p-2 rounded-full hover:bg-[#374248]">
                    <svg class="w-6 h-6 text-wa-light" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <h1 id="cat-header-title" class="font-medium text-lg text-wa-light">Nama Kategori</h1>
            </div>
        </div>

        <div id="cat-grid-container" class="max-w-md mx-auto p-3 grid grid-cols-2 gap-3">
            <!-- Inject via JS -->
        </div>
    </div>


    <!-- =======================
         VIEW 3: DETAIL PRODUCT
    ======================== -->
    <div id="view-detail" class="view-section bg-wa-bg min-h-screen">
        <!-- Header Detail (Transparan/Overlay) -->
        <div class="fixed top-0 w-full z-50 max-w-md mx-auto left-0 right-0">
            <div class="flex justify-between items-center p-4 bg-gradient-to-b from-black/60 to-transparent">
                <button onclick="goBack()" class="bg-black/30 backdrop-blur p-2 rounded-full text-white hover:bg-black/50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex gap-3">
                    <button class="bg-black/30 backdrop-blur p-2 rounded-full text-white hover:bg-black/50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 1:1 Image Slider -->
        <div class="max-w-md mx-auto relative bg-black group">
            <div class="w-full aspect-square relative overflow-hidden">
                <div id="detail-slider" class="flex overflow-x-auto snap-x snap-mandatory hide-scroll h-full items-center px-4 gap-3">
                    <!-- Inject via JS -->
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/20">
                <div id="slider-progress" class="h-full bg-wa-teal transition-all duration-300 w-[10%]"></div>
            </div>

            <!-- Navigation Arrows (Overlay) -->
            <button onclick="scrollSlider(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 backdrop-blur p-3 rounded-full text-white hover:bg-black/60 transition opacity-0 group-hover:opacity-100 hidden md:block">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <button onclick="scrollSlider(1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 backdrop-blur p-3 rounded-full text-white hover:bg-black/60 transition shadow-lg animate-pulse md:animate-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>

        <!-- Content Body -->
        <div class="max-w-md mx-auto bg-wa-bg p-5 pb-24">
            <!-- Title & Price -->
            <div class="border-b border-wa-divider pb-4 mb-4">
                <div class="flex justify-between items-start">
                    <h1 id="detail-title" class="text-xl font-medium text-wa-light leading-snug"></h1>
                    <span id="detail-category" class="text-[10px] text-wa-teal border border-wa-teal/30 px-2 py-0.5 rounded uppercase tracking-wide ml-2 shrink-0">Wedding</span>
                </div>
                <div class="mt-2 flex items-center gap-3">
                    <span id="detail-price-real" class="text-lg font-bold text-wa-light"></span>
                    <span id="detail-price-fake" class="text-sm text-wa-gray line-through"></span>
                </div>

                <!-- PREVIEW BUTTONS VARIANT -->
                <div id="detail-preview-buttons" class="mt-6">
                    <!-- Inject via JS -->
                </div>
            </div>

            <!-- Description -->
            <div class="space-y-3">
                <h3 class="text-sm font-medium text-wa-gray uppercase tracking-wide">Deskripsi Item</h3>
                <p id="detail-desc" class="text-sm text-wa-light leading-relaxed whitespace-pre-line"></p>
            </div>

            <!-- Variants Chips -->
            <div class="mt-6 pt-4 border-t border-wa-divider">
                <h3 class="text-sm font-medium text-wa-gray uppercase tracking-wide mb-3">Fitur Paket</h3>
                <div id="detail-variants" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Sticky Footer Action -->
        <div class="fixed bottom-0 w-full bg-wa-header border-t border-wa-divider p-3 z-50">
            <div class="max-w-md mx-auto flex gap-3">
                <button onclick="kirimPesanWA()" class="flex-1 bg-wa-teal text-white font-medium py-3 rounded-full shadow-lg text-sm flex justify-center items-center gap-2 hover:bg-[#008f6f] transition">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    Pesan via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- =======================
         VIEW 4: FULLSCREEN GALLERY
    ======================== -->
    <div id="view-gallery" class="fixed inset-0 z-[60] bg-black gallery-closed flex flex-col">
        <!-- Close Button -->
        <button onclick="closeGallery()" class="absolute top-4 right-4 z-50 bg-black/50 text-white p-3 rounded-full backdrop-blur-md">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        
        <!-- Vertical Scroll Container -->
        <div id="gallery-container" class="flex-1 overflow-y-auto hide-scroll snap-y snap-mandatory">
            <!-- Images Injected Here -->
        </div>
        
        <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none">
            <span class="bg-black/50 text-white text-xs px-3 py-1 rounded-full backdrop-blur">Scroll Kebawah</span>
        </div>
    </div>


    <!-- SCRIPT LOGIC -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDq6LjlUFRDm5CqGSqVLiJ9gItIyw71bAU",
            authDomain: "db-katalog.firebaseapp.com",
            projectId: "db-katalog",
            storageBucket: "db-katalog.firebasestorage.app",
            messagingSenderId: "597535674259",
            appId: "1:597535674259:web:0577885c617f623bb82266"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allProducts = [];
        let groupedProducts = {};
        const IMAGEKIT_BASE = "https://ik.imagekit.io/undangandigital";
        const TIER_ORDER = ["Starter", "Bronze", "Silver", "Gold", "Platinum", "Diamond"];
        const TIER_CONFIG = { "Starter": "ðŸŸ¢", "Bronze": "ðŸŸ¤", "Silver": "âšª", "Gold": "ðŸŸ¡", "Platinum": "ðŸ”µ", "Diamond": "ðŸ’Ž" };

        // --- SISTEM ROUTER & DEEP LINKING ---
        window.addEventListener('hashchange', router);

        function router() {
            const hash = window.location.hash;
            closeGallery(); // Tutup galeri jika pindah halaman

            if (!hash || hash === '#/') {
                switchView('view-home');
                return;
            }
            if (hash.startsWith('#/category/')) {
                const tier = decodeURIComponent(hash.split('/')[2]);
                renderCategoryView(tier);
                switchView('view-category');
                return;
            }
            if (hash.startsWith('#/detail/')) {
                const id = hash.split('/')[2];
                if (allProducts.length > 0) {
                    const item = allProducts.find(p => p.id === id);
                    if (item) {
                        renderDetailView(item);
                        switchView('view-detail');
                    } else {
                        window.location.hash = '#/';
                    }
                }
                return;
            }
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('view-active'));
            document.getElementById(viewId).classList.add('view-active');
            window.scrollTo(0,0);
        }

        function navigateTo(path) {
            window.location.hash = path;
        }

        function goBack() {
            window.history.back();
        }

        // --- LOAD DATA ---
        async function loadData() {
            try {
                const snapshot = await db.collection('themes').get();
                if (snapshot.empty) { alert("Data kosong!"); return; }

                allProducts = snapshot.docs.map(doc => {
                    let d = doc.data();
                    
                    // --- DATA CLEANING (PEMBERSIH SPASI) ---
                    // Pastikan variants selalu array dan tidak ada spasi di awal/akhir string
                    let variants = d.variants || [];
                    if (Array.isArray(variants)) {
                        variants = variants.map(v => v.trim()); // Hapus spasi " animasi" -> "animasi"
                    }

                    // --- FIX ENCODING DESCRIPTION ---
                    // Mengganti karakter error  menjadi bullet point atau strip
                    let desc = d.description || '';
                    // 1. Ganti  di awal baris dengan Bullet Point
                    desc = desc.replace(/\n\uFFFD/g, '\nâ€¢').replace(/^\uFFFD/, 'â€¢');
                    // 2. Ganti  lainnya dengan Strip (misal pemisah harga)
                    desc = desc.replace(/\uFFFD/g, '-');

                    return {
                        id: doc.id,
                        title: d.title || d['title '] || 'Tanpa Judul',
                        category: d.category || 'Umum',
                        price_real: d.price_real || d['price-real'] || 0,
                        price_fake: d.price_fake || d['price-fake'] || 0,
                        description: desc, // Gunakan deskripsi yang sudah dibersihkan
                        folder_id: d.folder_id || doc.id,
                        tier: (d.tier || 'Starter').trim(), // Bersihkan juga tier
                        variants: variants,
                        link: d.link || '#'
                    };
                });

                groupedProducts = {};
                allProducts.forEach(p => {
                    const tier = p.tier;
                    if(!groupedProducts[tier]) groupedProducts[tier] = [];
                    groupedProducts[tier].push(p);
                });

                document.getElementById('home-loading').style.display = 'none';
                renderHome();
                router();

            } catch (error) {
                console.error("Error:", error);
            }
        }

        // --- RENDERERS ---

        function renderHome() {
            const container = document.getElementById('tier-list-container');
            container.innerHTML = '';

            TIER_ORDER.forEach(tier => {
                const products = groupedProducts[tier];
                if (!products || products.length === 0) return;

                const prices = products.map(p => p.price_real);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                const priceRange = minPrice === maxPrice 
                    ? `All price at Rp${Math.floor(minPrice/1000)}k` 
                    : `Rp${Math.floor(minPrice/1000)}k - Rp${Math.floor(maxPrice/1000)}k`;

                const emoji = TIER_CONFIG[tier] || "ðŸ“¦";
                const previewProducts = products.slice(0, 3);
                
                let cardsHtml = '';
                previewProducts.forEach(item => {
                    const imgUrl = `${IMAGEKIT_BASE}/${item.folder_id}/01.png?tr=w-300`;
                    const price = 'Rp' + Math.floor(item.price_real / 1000) + 'k';
                    cardsHtml += `
                        <div onclick="navigateTo('#/detail/${item.id}')" class="cursor-pointer active:opacity-75 transition">
                            <div class="aspect-square rounded-lg overflow-hidden bg-wa-bg mb-2 border border-wa-divider/30">
                                <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy">
                            </div>
                            <h4 class="text-xs text-wa-light font-medium truncate">${item.title}</h4>
                            <span class="text-xs text-wa-teal font-bold">${price}</span>
                        </div>
                    `;
                });

                const section = document.createElement('div');
                section.className = "bg-wa-header mb-2 py-4 shadow-sm"; 
                section.innerHTML = `
                    <div class="px-4 flex justify-between items-center mb-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${emoji}</span>
                                <h2 class="text-wa-light font-bold text-base">Paket ${tier}</h2>
                            </div>
                            <p class="text-xs text-wa-gray mt-0.5 ml-7 font-medium">${priceRange}</p>
                        </div>
                        <button onclick="navigateTo('#/category/${tier}')" class="bg-[#2a373f] border border-wa-divider text-wa-teal text-xs font-bold px-3 py-1.5 rounded-full hover:bg-wa-teal hover:text-white transition active:scale-95 shadow-sm">
                            Lihat Semua
                        </button>
                    </div>
                    <div class="px-4 grid grid-cols-3 gap-3">
                        ${cardsHtml}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function renderCategoryView(tierName) {
            const products = groupedProducts[tierName];
            if(!products) return;

            document.getElementById('cat-header-title').innerText = `Paket ${tierName}`;
            const container = document.getElementById('cat-grid-container');
            container.innerHTML = '';

            products.forEach(item => {
                const imgUrl = `${IMAGEKIT_BASE}/${item.folder_id}/01.png?tr=w-400`;
                const price = 'Rp' + Math.floor(item.price_real / 1000) + 'k';
                const card = document.createElement('div');
                card.className = "bg-wa-header p-2 rounded-lg border border-wa-divider active:scale-[0.98] transition cursor-pointer";
                card.onclick = () => navigateTo(`#/detail/${item.id}`);
                card.innerHTML = `
                    <div class="aspect-square rounded overflow-hidden bg-wa-bg mb-2">
                        <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy">
                    </div>
                    <h3 class="text-sm font-medium text-wa-light truncate">${item.title}</h3>
                    <p class="text-sm font-bold text-wa-teal mt-1">${price}</p>
                `;
                container.appendChild(card);
            });
        }

        function renderDetailView(item) {
            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-price-real').innerText = 'Rp ' + item.price_real.toLocaleString('id-ID');
            document.getElementById('detail-price-fake').innerText = 'Rp ' + item.price_fake.toLocaleString('id-ID');
            document.getElementById('detail-desc').innerText = item.description;

            // --- 1. SET BUTTONS PREVIEW (SMART LAYOUT) ---
            const previewContainer = document.getElementById('detail-preview-buttons');
            previewContainer.innerHTML = '';
            
            // Title
            const titleLabel = document.createElement('h3');
            titleLabel.className = "text-xs font-bold text-wa-gray uppercase tracking-wider mb-2 col-span-full";
            titleLabel.innerHTML = "Lihat <span class='text-wa-teal'>Live Pre</span>view";
            previewContainer.appendChild(titleLabel);

            // Container Wrapper
            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = "flex flex-col gap-2";
            previewContainer.appendChild(buttonsWrapper);
            
            const baseUrl = item.link.replace(/\/$/, ""); 
            const sortOrder = ['foto', 'animasi', 'no-foto'];
            
            // Urutkan dan Filter varian yang valid saja
            const sortedVariants = (item.variants || [])
                .filter(v => ['foto', 'animasi', 'no-foto'].includes(v))
                .sort((a,b) => sortOrder.indexOf(a) - sortOrder.indexOf(b));

            // LOGIC:
            // 0 Varian -> Default Primary
            // 1 Varian -> Primary (Apapun jenisnya)
            // 2 Varian -> Grid 2 Kolom (Boxy)
            // 3 Varian -> 1 Primary (Atas) + 2 Grid Boxy (Bawah)

            if (sortedVariants.length === 0) {
                createPreviewButton(buttonsWrapper, item.link, "Preview Undangan", "default", true);
            } else if (sortedVariants.length === 1) {
                // 1 VARIANT -> ALWAYS PRIMARY
                const variant = sortedVariants[0];
                const d = getVariantDetails(variant, item, sortedVariants);
                createPreviewButton(buttonsWrapper, d.url, "Preview " + d.label, d.icon, true);
            } else if (sortedVariants.length === 2) {
                // 2 VARIANTS -> GRID 2 COL (BOXY)
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-2 gap-2";
                buttonsWrapper.appendChild(grid);
                
                sortedVariants.forEach(v => {
                    const d = getVariantDetails(v, item, sortedVariants);
                    createPreviewButton(grid, d.url, d.label, d.icon, false);
                });
            } else {
                // 3 VARIANTS -> MIXED
                // Item 1 (Primary)
                const v1 = sortedVariants[0];
                const d1 = getVariantDetails(v1, item, sortedVariants);
                createPreviewButton(buttonsWrapper, d1.url, "Preview " + d1.label, d1.icon, true);

                // Rest (Grid)
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-2 gap-2";
                buttonsWrapper.appendChild(grid);

                for(let i=1; i<sortedVariants.length; i++) {
                    const v = sortedVariants[i];
                    const d = getVariantDetails(v, item, sortedVariants);
                    createPreviewButton(grid, d.url, d.label, d.icon, false);
                }
            }

            // Variants Chips
            const variantContainer = document.getElementById('detail-variants');
            variantContainer.innerHTML = '';
            if(item.variants && item.variants.length > 0) {
                item.variants.forEach(v => {
                    variantContainer.innerHTML += `<span class="text-xs bg-wa-bg border border-wa-divider text-wa-gray px-3 py-1 rounded-full capitalize">${v}</span>`;
                });
            } else {
                variantContainer.innerHTML = '<span class="text-xs text-wa-gray italic">Tidak ada info fitur khusus</span>';
            }

            // --- IMAGE SLIDER LOGIC ---
            const slider = document.getElementById('detail-slider');
            slider.innerHTML = '';
            window.currentGalleryItem = item; 

            requestAnimationFrame(() => {
                slider.scrollLeft = 0;
            });

            for (let i = 1; i <= 10; i++) {
                const num = String(i).padStart(2, '0');
                let imgUrl = (i <= 8) ? `${IMAGEKIT_BASE}/${item.folder_id}/${num}.png` : `${IMAGEKIT_BASE}/feature-service/${num}.png`;
                imgUrl += "?tr=w-800"; 
                
                const slideItem = document.createElement('div');
                slideItem.className = "snap-center shrink-0 w-[85%] h-full flex items-center justify-center bg-wa-bg rounded-lg overflow-hidden relative border border-wa-divider/30 cursor-pointer";
                slideItem.onclick = () => openGallery(); 
                slideItem.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover" loading="${i===1?'eager':'lazy'}" onerror="this.src='https://placehold.co/400x500/333?text=Slide+Error'">`;
                slider.appendChild(slideItem);
            }

            const progressBar = document.getElementById('slider-progress');
            slider.onscroll = () => {
                const maxScroll = slider.scrollWidth - slider.clientWidth;
                const scrollPct = (slider.scrollLeft / maxScroll) * 100;
                progressBar.style.width = Math.max(10, scrollPct) + "%";
            };
            progressBar.style.width = "10%";
        }

        // --- HELPER UNTUK INFO VARIAN ---
        function getVariantDetails(variant, item, allVariants) {
            const baseUrl = item.link.replace(/\/$/, ""); 
            let url = item.link;
            let label = "Preview";
            let icon = "default";

            if (variant === 'foto') {
                url = item.link;
                label = "Versi Foto";
                icon = "camera";
            } else if (variant === 'animasi') {
                url = allVariants.length > 1 ? baseUrl + "-animasi" : item.link;
                label = "Versi Animasi";
                icon = "play";
            } else if (variant === 'no-foto') {
                url = allVariants.length > 1 ? baseUrl + "-tanpa-foto" : item.link;
                label = "Tanpa Foto";
                icon = "doc";
            }
            return { url, label, icon };
        }

        // --- GALLERY / LIGHTBOX FUNCTIONS ---
        function openGallery() {
            const item = window.currentGalleryItem;
            if(!item) return;

            const galleryView = document.getElementById('view-gallery');
            const container = document.getElementById('gallery-container');
            container.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const num = String(i).padStart(2, '0');
                let imgUrl = (i <= 8) ? `${IMAGEKIT_BASE}/${item.folder_id}/${num}.png` : `${IMAGEKIT_BASE}/feature-service/${num}.png`;
                imgUrl += "?tr=w-1000"; 

                const wrapper = document.createElement('div');
                wrapper.className = "w-full min-h-[50vh] snap-start mb-1"; 
                wrapper.innerHTML = `<img src="${imgUrl}" class="w-full h-auto object-contain" loading="lazy">`;
                container.appendChild(wrapper);
            }

            galleryView.classList.remove('gallery-closed');
            galleryView.classList.add('gallery-open');
        }

        function closeGallery() {
            const galleryView = document.getElementById('view-gallery');
            galleryView.classList.remove('gallery-open');
            galleryView.classList.add('gallery-closed');
        }

        // --- SLIDER NAVIGATION (DESKTOP) ---
        function scrollSlider(direction) {
            const slider = document.getElementById('detail-slider');
            const scrollAmount = slider.offsetWidth * 0.85; 
            slider.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        function createPreviewButton(container, url, text, iconType, isPrimary = false) {
            let iconSvg = '';
            if (iconType === 'camera') iconSvg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>';
            else if (iconType === 'play') iconSvg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            else if (iconType === 'doc') iconSvg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
            else iconSvg = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>';

            const btn = document.createElement('a');
            btn.href = url;
            btn.target = "_blank";
            
            let classes = "relative overflow-hidden group border border-wa-divider rounded-xl hover:border-wa-teal transition-all active:scale-[0.98] ";
            
            if (isPrimary) {
                // Primary Button Style (Horizontal, Full Width)
                classes += "bg-[#202c33] p-4 flex items-center justify-center gap-3 w-full shadow-md";
                btn.innerHTML = `
                    <div class="text-wa-teal group-hover:text-white transition-colors">${iconSvg}</div>
                    <span class="text-sm font-bold text-wa-light tracking-wide uppercase group-hover:text-white">${text}</span>
                    <div class="absolute inset-0 bg-wa-teal/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                `;
            } else {
                // Secondary Button Style (Vertical/Boxy)
                classes += "bg-[#2a373f] p-3 flex flex-col items-center justify-center gap-2 h-20 shadow-sm";
                btn.innerHTML = `
                    <div class="text-wa-teal/80 group-hover:text-white transition-colors scale-90">${iconSvg}</div>
                    <span class="text-xs font-medium text-wa-gray group-hover:text-wa-light text-center leading-tight">${text}</span>
                `;
            }
            
            btn.className = classes;
            container.appendChild(btn);
        }

        function kirimPesanWA() {
            if(!window.currentItem) return;
            const item = window.currentItem;
            const text = `Halo Admin, saya tertarik dengan tema undangan *${item.title}* (Paket ${item.tier}) seharga Rp ${item.price_real.toLocaleString('id-ID')}. Info lebih lanjut?`;
            const url = `https://wa.me/6281234567890?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        window.onload = loadData;

    </script>
</body>
</html>
